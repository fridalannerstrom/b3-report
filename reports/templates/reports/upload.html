{% load static %}
{% load report_extras %}
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>Kompetensrapport</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{% static 'reports/css/report.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="container">
  <h1>Generera kompetensrapport</h1>

  <div class="upload-box">
    <form method="post" enctype="multipart/form-data" >
      {% csrf_token %}
      {{ form.as_p }}
      <button class="btn btn-primary" type="submit">Ladda upp &amp; visa rapport</button>
    </form>
  </div>

  {% if error %}
    <p class="message error">{{ error }}</p>
  {% endif %}

{% if competencies %}
<div class="preview-card" id="reportBox">
  <div class="report-surface">
    {% include "reports/_report_content.html" %}
  </div>

  <a href="{% url 'report_pdf_download' %}" class="btn btn-secondary">Ladda ned som PDF</a>
  </div>

  <script>
    const labels = {{ chart_labels|safe }};
    const values = {{ chart_values|safe }};

    const ctx = document.getElementById('competencyChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: wrappedLabels,
        datasets: [{ label: 'Kompetenspoäng', data: values }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true, max: 5 } } }
    });
  </script>
{% endif %}

</div>

<script>
  const fileInput = document.querySelector('#id_file');
  if (fileInput) fileInput.setAttribute('accept', '.xlsx,.xls');
</script>



  <!-- Radar init: EN gång -->
  <script>
  (function () {
    const elLabels = document.getElementById("radar-labels");
    const elValues = document.getElementById("radar-values");
    const canvas = document.getElementById("radarChart");
    if (!elLabels || !elValues || !canvas) return;

    const labels = JSON.parse(elLabels.textContent);
    const values = JSON.parse(elValues.textContent);
    const ctx = canvas.getContext("2d");

    function wrapLabel(label, maxChars = 18) {
      const words = label.split(" ");
      const lines = [];
      let current = "";
      words.forEach(word => {
        const next = current ? (current + " " + word) : word;
        if (next.length <= maxChars) current = next;
        else { if (current) lines.push(current); current = word; }
      });
      if (current) lines.push(current);
      return lines;
    }

    const wrappedLabels = labels.map(l => wrapLabel(l, 18));

    window.radarChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels: wrappedLabels,
        datasets: [{
          data: values,
          borderColor: "#028081",
          backgroundColor: "rgba(2, 128, 129, 0.20)",
          borderWidth: 2.5,
          fill: true,
          pointRadius: 3,
          pointHoverRadius: 4,
          pointBackgroundColor: "#028081",
          pointBorderColor: "#028081",
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // ✅ viktigt i PDF
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          r: {
            min: 0, max: 100,
            ticks: { display: false },
            angleLines: { color: "rgba(0,0,0,0.05)" },
            grid: { circular: true, color: "rgba(0,0,0,0.06)" },
            pointLabels: {
              font: { family: "'Work Sans', sans-serif", size: 10, weight: "600" },
              color: "#222",
              padding: 12
            }
          }
        }
      }
    });

    window.__RADAR_READY__ = true;
  })();
  </script>


</body>
</html>
