{% if competencies %}
<h2>Rapport för {{ full_name }}</h2>

<!-- INLEDNING -->

<section class="report-section intro">

<h2>Översikt: huvudbeteenden</h2>
<div style="max-width: 650px; margin: 0 auto;">
  <canvas id="radarChart" height="340"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ radar_labels|json_script:"radar-labels" }}
{{ radar_values|json_script:"radar-values" }}

<script>
  const labels = JSON.parse(document.getElementById("radar-labels").textContent);
  const values = JSON.parse(document.getElementById("radar-values").textContent);

  const ctx = document.getElementById("radarChart").getContext("2d");

  new Chart(ctx, {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "Total score",
        data: values,
        fill: true,
        borderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }, // ✅ inga labels/legend
        tooltip: {
          enabled: false // ✅ inga siffror vid hover (om du vill)
        }
      },
      scales: {
        r: {
          min: 0,
          max: 30,                 // ✅ 0–30 skala
          ticks: { display: false }, // ✅ döljer 0,10,20,30
          pointLabels: {
            font: { size: 12 }
          },
          grid: { circular: true }
        }
      }
    }
  });
</script>

{% if insights.most_natural and insights.needs_development %}
  <div class="insight-cards">
    <div class="insight-card">
      <h3>Mest naturligt</h3>
      <p><strong>{{ insights.most_natural.name }}</strong></p>
      <p class="small-muted">Score (debug): {{ insights.most_natural.total_score|floatformat:1 }}</p>
    </div>

    <div class="insight-card">
      <h3>Behöver utvecklas</h3>
      <p><strong>{{ insights.needs_development.name }}</strong></p>
      <p class="small-muted">Score (debug): {{ insights.needs_development.total_score|floatformat:1 }}</p>
    </div>
  </div>
{% endif %}

{% if insights.top_energy and insights.low_energy %}
  <div class="energy-section">

    <div class="energy-block positive">
      <h3>Detta ger energi</h3>
      <ul>
        {% for u in insights.top_energy %}
          <li>
            <strong>{{ u.name }}</strong>
            <span class="muted">({{ u.score_5|floatformat:1 }} / 5)</span>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="energy-block negative">
      <h3>Detta tar energi</h3>
      <ul>
        {% for u in insights.low_energy %}
          <li>
            <strong>{{ u.name }}</strong>
            <span class="muted">({{ u.score_5|floatformat:1 }} / 5)</span>
          </li>
        {% endfor %}
      </ul>
    </div>

  </div>
{% endif %}

  <h2>Inledning</h2>

  <p>
    Den här rapporten sammanfattar resultat från TQ-kompetenser (rådata från Excel)
    och en mappning till B3:s ledarskapsbeteenden. Syftet är att ge en tydlig överblick
    över styrkor och utvecklingsområden i relation till de beteenden som efterfrågas.
  </p>

  <p>
    Resultaten presenteras på en femgradig skala (1–5). Skalan visar en indikation på
    hur effektiv personen sannolikt är i att omsätta kompetensen/beteendet i arbetet.
  </p>

  <!-- TOLKNING AV SKALA -->

  <h3>Hur du tolkar den femgradiga skalan</h3>

  <table class="scale-table">
    <thead>
      <tr>
        <th style="width: 20%;">Nivå</th>
        <th style="width: 30%;">Benämning</th>
        <th>Tolkning</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>1</strong></td>
        <td>Utrymme för utveckling</td>
        <td>
          Personen bedöms ligga under många andra. Indikerar tydligt utvecklingsområde.
        </td>
      </tr>
      <tr>
        <td><strong>2</strong></td>
        <td>Tillräcklig</td>
        <td>
          Personen ligger något under genomsnittet. Kan fungera, men kan behöva stöd eller träning.
        </td>
      </tr>
      <tr>
        <td><strong>3</strong></td>
        <td>God</td>
        <td>
          Personen ligger ungefär som de flesta. Stabil nivå som ofta fungerar väl i vardagen.
        </td>
      </tr>
      <tr>
        <td><strong>4</strong></td>
        <td>Mycket god</td>
        <td>
          Personen ligger över många andra. Tydlig styrka och förmåga att prestera i fler situationer.
        </td>
      </tr>
      <tr>
        <td><strong>5</strong></td>
        <td>Utmärkt</td>
        <td>
          Personen ligger över de flesta. Stark och konsekvent förmåga att omsätta detta i praktiken.
        </td>
      </tr>
    </tbody>
  </table>

  <p class="note">
    Obs: Resultat ska alltid tolkas tillsammans med övrig information (t.ex. rollkrav,
    erfarenhet och intervjudata). Rapporten är ett beslutsstöd, inte ett facit.
  </p>
</section>

<!-- B3 RESULTAT -->

<section class="report-section">
  <h2>Resultat på B3:s ledarskapsbeteenden</h2>
  <p>
    Resultaten visas på en femgradig skala (1–5) där varje beteende presenteras
    tillsammans med tillhörande underbeteenden.
  </p>

  {% for cluster in b3_clusters %}
  <div class="b3-group">

<!-- HUVUDBETEENDE -->
<div class="b3-main">
  <h3 class="b3-main-title">{{ cluster.name }}</h3>

  {# --- TOTAL SCORE donut --- #}
  {% with max_total=40 %}
    {# max_total är bara en placeholder för nu.
       Sen kan vi räkna ut korrekt max per kluster dynamiskt. #}

    {% if cluster.total_score != None %}
      {% with pct=cluster.pct_total %}
        <div class="donut-wrap">
          <div class="donut" style="--p: {{ cluster.total_score|floatformat:0|add:'0' }};">
            {# OBS: den här --p-linjen är “hackig” pga Django math-begränsningar.
               Vi använder istället en enkel lösning nedan med data-attribut om du vill. #}
            <div class="donut-label">{{ cluster.total_score|floatformat:1 }}</div>
          </div>

          <div class="donut-meta">
            <div><strong>Total score:</strong> {{ cluster.total_score|floatformat:1 }}</div>
            <div class="small-muted">Just nu visas siffran för att vi ska kunna verifiera. Tas bort senare.</div>
            <div class="small-muted">Max (placeholder): {{ max_total }}</div>
          </div>
        </div>
      {% endwith %}
    {% else %}
      <span class="no-data">Ingen data</span>
    {% endif %}
  {% endwith %}

  {% if cluster.calc_debug %}
    <details class="calc-details calc-cluster">
      <summary class="calc-summary">Visa uträkning</summary>

      <div class="calc-box">
        {% if cluster.calc_human %}
          <div class="calc-formula">
            <strong>Så räknas det:</strong>
            summa av (<em>underbeteende-score × underbeteendevikt</em>)
          </div>

          <div class="calc-line">
            <strong>Uträkning:</strong> {{ cluster.calc_human.line }}
          </div>
        {% endif %}

        {% if cluster.calc_debug.items_used %}
          <table class="calc-table">
            <thead>
              <tr>
                <th>Underbeteende</th>
                <th>Värde</th>
                <th>Vikt</th>
                <th>Värde × vikt</th>
              </tr>
            </thead>
            <tbody>
              {% for it in cluster.calc_debug.items_used %}
                <tr>
                  <td>{{ it.underbehavior }}</td>
                  <td>{{ it.score|floatformat:2 }}</td>
                  <td>{{ it.weight|floatformat:0 }}</td>
                  <td>{{ it.weighted|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="calc-result">
            <strong>Resultat (total score):</strong> {{ cluster.total_score|floatformat:2 }}
          </div>
        {% else %}
          <div class="no-data">Ingen data tillgänglig för detta huvudbeteende.</div>
        {% endif %}
      </div>
    </details>
  {% endif %}
</div>


    <!-- UNDERBETEENDEN -->
    <div class="b3-under">
      {% for u in b3_underbehaviors %}
      {% if u.cluster == cluster.name %}
      <div class="b3-under-row">
        <div class="b3-under-name">{{ u.name }}</div>

        <div class="b3-scale">
          {% with steps=u.score_5_half_steps %}
          {% if steps != None %}
          {% for i in "12345" %}
          {% with step=forloop.counter|add:forloop.counter %}
          {% if steps >= step %}
          <span class="dot small filled"></span>
          {% elif steps == step|add:"-1" %}
          <span class="dot small half"></span>
          {% else %}
          <span class="dot small"></span>
          {% endif %}
          {% endwith %}
          {% endfor %}
          {% else %}
          <span class="no-data">Ingen data</span>
          {% endif %}
          {% endwith %}


        </div>

      </div>
      {# --- Debug/uträkning per underbeteende --- #}
      {% if u.calc_debug %}
      <details class="calc-details">
        <summary class="calc-summary">Visa uträkning</summary>

        <div class="calc-box">
          <div class="calc-formula">
            <div class="calc-formula">
              <strong>Så räknas det:</strong>
              (summa av <em>kompetensvärden</em>) / (antal kompetenser)
            </div>

            {% if u.calc_human %}
            <div class="calc-line">
              <strong>Uträkning:</strong> {{ u.calc_human.line }}
            </div>
            {% endif %}
          </div>

          {% if u.calc_debug.components %}
          <table class="calc-table">
            <thead>
              <tr>
                <th>Kompetens</th>
                <th>Värde</th>
                <th>Vikt</th>
                <th>Värde × vikt</th>
              </tr>
            </thead>
            <tbody>
              {% for comp in u.calc_debug.components %}
              <tr>
                <td>{{ comp.competency }}</td>
                <td>{{ comp.score|floatformat:2 }}</td>
                <td>{{ comp.weight|floatformat:2 }}</td>
                <td>{{ comp.weighted|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="calc-result">
            <strong>Resultat:</strong> {{ u.score_5|floatformat:2 }} / 5
          </div>
          {% else %}
          <div class="no-data">Ingen kompetensdata hittades för detta underbeteende.</div>
          {% endif %}

          {% if u.missing %}
          <div class="calc-missing">
            <strong>Saknas i Excel:</strong>
            {{ u.missing|join:", " }}
          </div>
          {% endif %}
        </div>
      </details>
      {% endif %}


      {% endif %}
      {% endfor %}
    </div>

  </div>
  {% endfor %}
</section>

<!-- 3. VISUELL MAPPNING -->

<section class="report-section">
  <h2>Visuell mappning: B3-beteenden → TQ-kompetenser</h2>
  <p>
    Här visas hur varje B3-underbeteende är kopplat till TQ-kompetenser enligt mappningen.
  </p>

  {% for cluster in b3_clusters %}
  <div class="map-card">
    <div class="map-header">
      <h3 class="map-title">{{ cluster.name }}</h3>
    </div>

    <div class="map-body">
      {% for u in b3_underbehaviors %}
      {% if u.cluster == cluster.name %}
      <div class="map-row">
        <div class="map-left">
          <div class="map-behavior">{{ u.name }}</div>
        </div>

        <div class="map-mid" aria-hidden="true">
          <span class="map-arrow">→</span>
        </div>

        <div class="map-right">
          {% if u.competencies %}
          <div class="chip-wrap">
            {% for c in u.competencies %}
            <span class="chip">{{ c }}</span>
            {% endfor %}
          </div>
          {% else %}
          <span class="no-data">Ingen mappning</span>
          {% endif %}
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<!-- 4. RESULTAT TQ KOMPETENSER -->

<section class="report-section">
  <h2>Resultat på TQ:s kompetenser</h2>
  <p>Detta är rådata från Excel. Varje kompetens visas på en femgradig skala (1–5).</p>

  <div class="tq-grid">
    {% for c in competencies %}
    <div class="tq-row">
      <div class="tq-name">{{ c.name }}</div>

      <div class="tq-scale">
        {% for i in "12345" %}
        <span class="dot {% if c.score_5_rounded >= i|add:'0' %}filled{% endif %}"></span>
        {% endfor %}
        <span class="tq-value">{{ c.score_5|floatformat:2 }} / 5</span>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<h2>Resultat på B3:s ledarskapsbeteenden (huvudbeteenden)</h2>
<table>
  <thead>
    <tr>
      <th>Huvudbeteende</th>
      <th>Värde (1–5)</th>
    </tr>
  </thead>
  <tbody>
    {% for item in b3_clusters %}
    <tr>
      <td>{{ item.name }}</td>
      <td>
        {% if item.score_5 %}
        {{ item.score_5|floatformat:2 }}
        {% else %}
        Ingen data
        {% endif %}
      </td>
      <td>
        {% if item.score_100 %}
        {{ item.score_100|floatformat:1 }}
        {% else %}
        –
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h3>B3 Underbeteenden</h3>
<table>
  <thead>
    <tr>
      <th>Huvudområde</th>
      <th>Beteende</th>
      <th>Värde (1–5)</th>
    </tr>
  </thead>
  <tbody>
    {% for item in b3_underbehaviors %}
    <tr>
      <td>{{ item.cluster }}</td>
      <td>{{ item.name }}</td>
      <td>
        {% if item.score_5 %}
        {{ item.score_5|floatformat:2 }}
        {% else %}
        –
        {% endif %}
      </td>
      <td>
        {% if item.score_100 %}
        {{ item.score_100|floatformat:1 }}
        {% else %}
        –
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Jämförelse: viktat vs oviktat</h2>

<h3>Underbeteenden</h3>
<table>
  <thead>
    <tr>
      <th>Kluster</th>
      <th>Underbeteende</th>
      <th>Viktat</th>
      <th>Oviktat</th>
      <th>Diff</th>
    </tr>
  </thead>
  <tbody>
    {% for r in under_compare_rows %}
    <tr>
      <td>{{ r.cluster }}</td>
      <td>{{ r.name }}</td>
      <td>{{ r.weighted|floatformat:2 }}</td>
      <td>{{ r.unweighted|floatformat:2 }}</td>
      <td>{{ r.diff|floatformat:2 }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h3>Huvudbeteenden</h3>
<table>
  <thead>
    <tr>
      <th>Huvudbeteende</th>
      <th>Viktat</th>
      <th>Oviktat</th>
      <th>Diff</th>
    </tr>
  </thead>
  <tbody>
    {% for r in cluster_compare_rows %}
    <tr>
      <td>{{ r.name }}</td>
      <td>{{ r.weighted|floatformat:2 }}</td>
      <td>{{ r.unweighted|floatformat:2 }}</td>
      <td>{{ r.diff|floatformat:2 }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>



{% else %}
<p>Ingen rapport att visa (ladda upp en Excel först).</p>
{% endif %}