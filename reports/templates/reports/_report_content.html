{% if competencies %}
  <h2>Rapport för {{ full_name }}</h2>

<!-- INLEDNING -->

  <section class="report-section intro">
  <h2>Inledning</h2>

  <p>
    Den här rapporten sammanfattar resultat från TQ-kompetenser (rådata från Excel)
    och en mappning till B3:s ledarskapsbeteenden. Syftet är att ge en tydlig överblick
    över styrkor och utvecklingsområden i relation till de beteenden som efterfrågas.
  </p>

  <p>
    Resultaten presenteras på en femgradig skala (1–5). Skalan visar en indikation på
    hur effektiv personen sannolikt är i att omsätta kompetensen/beteendet i arbetet.
  </p>

<!-- TOLKNING AV SKALA -->

  <h3>Hur du tolkar den femgradiga skalan</h3>

  <table class="scale-table">
    <thead>
      <tr>
        <th style="width: 20%;">Nivå</th>
        <th style="width: 30%;">Benämning</th>
        <th>Tolkning</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>1</strong></td>
        <td>Utrymme för utveckling</td>
        <td>
          Personen bedöms ligga under många andra. Indikerar tydligt utvecklingsområde.
        </td>
      </tr>
      <tr>
        <td><strong>2</strong></td>
        <td>Tillräcklig</td>
        <td>
          Personen ligger något under genomsnittet. Kan fungera, men kan behöva stöd eller träning.
        </td>
      </tr>
      <tr>
        <td><strong>3</strong></td>
        <td>God</td>
        <td>
          Personen ligger ungefär som de flesta. Stabil nivå som ofta fungerar väl i vardagen.
        </td>
      </tr>
      <tr>
        <td><strong>4</strong></td>
        <td>Mycket god</td>
        <td>
          Personen ligger över många andra. Tydlig styrka och förmåga att prestera i fler situationer.
        </td>
      </tr>
      <tr>
        <td><strong>5</strong></td>
        <td>Utmärkt</td>
        <td>
          Personen ligger över de flesta. Stark och konsekvent förmåga att omsätta detta i praktiken.
        </td>
      </tr>
    </tbody>
  </table>

  <p class="note">
    Obs: Resultat ska alltid tolkas tillsammans med övrig information (t.ex. rollkrav,
    erfarenhet och intervjudata). Rapporten är ett beslutsstöd, inte ett facit.
  </p>
</section>

<!-- B3 RESULTAT -->

<section class="report-section">
  <h2>Resultat på B3:s ledarskapsbeteenden</h2>
  <p>
    Resultaten visas på en femgradig skala (1–5) där varje beteende presenteras
    tillsammans med tillhörande underbeteenden.
  </p>

  {% for cluster in b3_clusters %}
    <div class="b3-group">

      <!-- HUVUDBETEENDE -->
      <div class="b3-main">
        <h3 class="b3-main-title">{{ cluster.name }}</h3>

            <div class="b3-scale">
            {% if cluster.score_5 %}
                {% with rounded=cluster.score_5|floatformat:0|add:"0" %}
                {% for i in "12345" %}
                    {% with n=i|add:"0" %}
                    <span class="dot {% if rounded >= n %}filled{% endif %}"></span>
                    {% endwith %}
                {% endfor %}
                {% endwith %}
                <span class="b3-value">{{ cluster.score_5|floatformat:2 }} / 5</span>
            {% else %}
                <span class="no-data">Ingen data</span>
            {% endif %}
            </div>

      </div>

      <!-- UNDERBETEENDEN -->
      <div class="b3-under">
        {% for u in b3_underbehaviors %}
          {% if u.cluster == cluster.name %}
            <div class="b3-under-row">
              <div class="b3-under-name">{{ u.name }}</div>

                <div class="b3-scale">
                {% if u.score_5 != None %}
                    {% with rounded=u.score_5|floatformat:0|add:"0" %}
                    {% for i in "12345" %}
                        {% with n=i|add:"0" %}
                        <span class="dot small{% if rounded >= n %} filled{% endif %}"></span>
                        {% endwith %}
                    {% endfor %}
                    {% endwith %}
                    <span class="b3-value small">{{ u.score_5|floatformat:2 }}</span>
                {% else %}
                    <span class="no-data">Ingen data</span>
                {% endif %}
                </div>

            </div>
          {% endif %}
        {% endfor %}
      </div>

    </div>
  {% endfor %}
</section>

<!-- 3. VISUELL MAPPNING -->

<section class="report-section">
  <h2>Visuell mappning: B3-beteenden → TQ-kompetenser</h2>
  <p>
    Här visas hur varje B3-underbeteende är kopplat till TQ-kompetenser enligt mappningen.
  </p>

  {% for cluster in b3_clusters %}
    <div class="map-card">
      <div class="map-header">
        <h3 class="map-title">{{ cluster.name }}</h3>
      </div>

      <div class="map-body">
        {% for u in b3_underbehaviors %}
          {% if u.cluster == cluster.name %}
            <div class="map-row">
              <div class="map-left">
                <div class="map-behavior">{{ u.name }}</div>
              </div>

              <div class="map-mid" aria-hidden="true">
                <span class="map-arrow">→</span>
              </div>

              <div class="map-right">
                {% if u.competencies %}
                  <div class="chip-wrap">
                    {% for c in u.competencies %}
                      <span class="chip">{{ c }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="no-data">Ingen mappning</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</section>

<!-- 4. RESULTAT TQ KOMPETENSER -->

<section class="report-section">
  <h2>Resultat på TQ:s kompetenser</h2>
  <p>Detta är rådata från Excel. Varje kompetens visas på en femgradig skala (1–5).</p>

  <div class="tq-grid">
    {% for c in competencies %}
      <div class="tq-row">
        <div class="tq-name">{{ c.name }}</div>

        <div class="tq-scale">
          {% for i in "12345" %}
            <span class="dot {% if c.score_5_rounded >= i|add:'0' %}filled{% endif %}"></span>
          {% endfor %}
          <span class="tq-value">{{ c.score_5|floatformat:2 }} / 5</span>
        </div>
      </div>
    {% endfor %}
  </div>
</section>

  <h2>Resultat på B3:s ledarskapsbeteenden (huvudbeteenden)</h2>
<table>
  <thead>
    <tr>
      <th>Huvudbeteende</th>
      <th>Värde (1–5)</th>
    </tr>
  </thead>
  <tbody>
    {% for item in b3_clusters %}
<tr>
  <td>{{ item.name }}</td>
  <td>
    {% if item.score_5 %}
      {{ item.score_5|floatformat:2 }}
    {% else %}
      Ingen data
    {% endif %}
  </td>
  <td>
    {% if item.score_100 %}
      {{ item.score_100|floatformat:1 }}
    {% else %}
      –
    {% endif %}
  </td>
</tr>
{% endfor %}
  </tbody>
</table>

  <h3>B3 Underbeteenden</h3>
  <table>
    <thead>
      <tr><th>Huvudområde</th><th>Beteende</th><th>Värde (1–5)</th></tr>
    </thead>
    <tbody>
      {% for item in b3_underbehaviors %}
<tr>
  <td>{{ item.cluster }}</td>
  <td>{{ item.name }}</td>
  <td>
    {% if item.score_5 %}
      {{ item.score_5|floatformat:2 }}
    {% else %}
      –
    {% endif %}
  </td>
  <td>
    {% if item.score_100 %}
      {{ item.score_100|floatformat:1 }}
    {% else %}
      –
    {% endif %}
  </td>
</tr>
{% endfor %}
    </tbody>
  </table>
{% else %}
  <p>Ingen rapport att visa (ladda upp en Excel först).</p>
{% endif %}